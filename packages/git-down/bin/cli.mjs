#!/usr/bin/env node
import{defineCommand as B,runMain as v}from"citty";import{exit as m}from"node:process";import{extname as k,resolve as s}from"node:path";import{exec as A}from"node:child_process";import{existsSync as f}from"node:fs";import{mkdir as q,rm as R,cp as U,rename as j,readFile as x,writeFile as G}from"node:fs/promises";import{promisify as L}from"node:util";const S="0.2.2",c=L(A);async function b(t){if(!f(t))return q(t,{recursive:!0})}async function h(t){if(f(t))return R(t,{recursive:!0,force:!0}).catch(()=>{})}function H(t){return{output:"./git-down",branch:"main",...t}}function I(t){return o=>{if(o){if(!t)throw o;t(o)}t&&t(null)}}function w(t){const o=t.replace(/(^https?:\/\/github\.com\/)|(^git@github\.com:)/,"/"),[,e,n,,u="",...i]=o.split("/"),r=i.join("/"),l=o.includes("blob")||!!k(r);return{href:t,owner:e,project:n.replace(/\.git$/,""),isRepo:o.endsWith(".git")||!o.includes("tree")&&!o.includes("blob"),sourceType:l?"file":"dir",branch:u,pathname:r}}async function M(t,o){return f(o)?U(t,o,{recursive:!0}):j(t,o)}function O(t){const{gitInfo:o,option:e,callback:n}=t,{branch:u,output:i}=e,{owner:r,project:l}=o,p={cwd:s(i)};return c("git init --quiet",p).then(()=>c(`git remote add origin https://github.com/${r}/${l}`,p),n).then(()=>c(`git pull origin --quiet ${u} --depth 1`,p),n).then(()=>h(s(i,".git")),n)}async function P(t){const{gitInfo:o,callback:e,option:n}=t,{output:u}=n,{pathname:i,sourceType:r,branch:l,owner:p,project:E}=o,a=s(u,`./.git-down-temp-folder-${Date.now()}-${Math.random().toString(36).slice(2)}`);f(a)&&h(a),await b(a).catch(e);const g=s(a,".git/info/sparse-checkout"),$=r==="file"?i:`${i}/*`,D=`${f(g)?await x(g,{encoding:"utf-8"}):""}
${$}`,C=s(u,i.split("/").pop()),d={cwd:a},F=`remote-${Date.now()}-${Math.random().toString(36).slice(2)}`;return c("git init --quiet",d).then(()=>c(`git remote add ${F} https://github.com/${p}/${E}`,d),e).then(async()=>{try{if((await c("git config --get core.sparseCheckout",d)).stdout.trim()==="true")return}catch{}return c("git config core.sparseCheckout true",d)},e).then(()=>G(g,D),e).then(()=>c(`git pull ${F} --quiet ${l} --depth 1`,d),e).then(()=>M(s(a,i),C),e).then(()=>h(a),e)}function T(t,o,e){const n=H(o),u=I(e),i=w(t),r={option:n,callback:u,gitInfo:i};b(n.output).then(()=>(i.isRepo?O:P)(r),u).then(()=>u(null),u)}function W(t,o){return new Promise((e,n)=>{T(t,o,u=>{u?n(u):e()})})}function _(t){return!t||typeof t!="string"?!1:/^https?:\/\/github\.com\/[\w.-]+\/[\w.-]+/.test(t)}function y(t,o){return typeof t=="string"?t:o}async function z(t){try{const o=t.url||t._[0];o||(console.error("\u274C Error: URL is required"),console.log("Use --help for usage information"),m(1)),_(o)||(console.error("\u274C Error: Invalid GitHub URL format"),console.log("Please provide a valid GitHub repository, file, or directory URL"),m(1));const e=w(o),n=typeof t.name=="string"?t.name:e.project,u={output:y(t.output,`./${n||e.project}`),branch:y(t.branch,e.branch||"master")};console.log(`\u{1F680} Starting download from: ${o}`),console.log(`\u{1F4C1} Output directory: ${u.output}`),await W(o,u),console.log("\u2705 Download completed successfully!")}catch(o){console.error("\u274C Download failed:",o instanceof Error?o.message:String(o)),m(1)}}const J=B({meta:{name:"gd",description:"\u4E0B\u8F7D GitHub \u4ED3\u5E93\u6587\u4EF6\u6216\u76EE\u5F55",version:S},args:{url:{type:"positional",description:"GitHub \u4ED3\u5E93URL\u6216\u6587\u4EF6/\u76EE\u5F55URL",required:!0},output:{type:"string",description:"\u6307\u5B9A\u5B8C\u6574\u7684\u8F93\u51FA\u8DEF\u5F84\uFF0C\u652F\u6301\u76F8\u5BF9\u6216\u7EDD\u5BF9\u8DEF\u5F84 (\u4F8B\u5982: ./path \u6216 /path)",alias:["o","out"]},branch:{type:"string",description:"\u6307\u5B9A\u8981\u4E0B\u8F7D\u7684\u5206\u652F\u540D\u79F0",alias:["b"],default:"master"},help:{type:"boolean",description:"\u663E\u793A\u5E2E\u52A9\u4FE1\u606F",alias:["h"],default:!1},name:{type:"positional",description:"\u7B80\u4FBF\u65B9\u5F0F\uFF1A\u6307\u5B9A\u8F93\u51FA\u6587\u4EF6\u5939\u540D\u79F0 (\u7C7B\u4F3C git clone \u7684\u7528\u6CD5)",required:!1}},async run({args:t}){await z(t)}});v(J);

