#!/usr/bin/env node
import{defineCommand as D,runMain as B}from"citty";import{exit as g}from"node:process";import{extname as v,resolve as s}from"node:path";import{exec as k}from"node:child_process";import{existsSync as f}from"node:fs";import{mkdir as A,rm as q,cp as R,rename as U,readFile as j,writeFile as x}from"node:fs/promises";import{promisify as G}from"node:util";const L="0.3.0",c=G(k);async function b(t){if(!f(t))return A(t,{recursive:!0})}async function h(t){if(f(t))return q(t,{recursive:!0,force:!0}).catch(()=>{})}function S(t){return{output:"./git-down",branch:"main",...t}}function H(t){return o=>{if(o){if(!t)throw o;t(o)}t&&t(null)}}function w(t){const o=t.replace(/(^https?:\/\/github\.com\/)|(^git@github\.com:)/,"/"),[,e,u,,n="",...i]=o.split("/"),r=i.join("/"),l=o.includes("blob")||!!v(r);return{href:t,owner:e,project:u.replace(/\.git$/,""),isRepo:o.endsWith(".git")||!o.includes("tree")&&!o.includes("blob"),sourceType:l?"file":"dir",branch:n,pathname:r}}async function I(t,o){f(o)?await R(t,o,{recursive:!0}):await U(t,o)}function M(t){const{gitInfo:o,option:e,callback:u}=t,{branch:n,output:i}=e,{owner:r,project:l}=o,p={cwd:s(i)};return c("git init --quiet",p).then(()=>c(`git remote add origin https://github.com/${r}/${l}`,p),u).then(()=>c(`git pull origin --quiet ${n} --depth 1`,p),u).then(()=>h(s(i,".git")),u)}async function O(t){const{gitInfo:o,callback:e,option:u}=t,{output:n}=u,{pathname:i,sourceType:r,branch:l,owner:p,project:y}=o,a=s(n,`./.git-down-temp-folder-${Date.now()}-${Math.random().toString(36).slice(2)}`);f(a)&&h(a),await b(a).catch(e);const m=s(a,".git/info/sparse-checkout"),E=r==="file"?i:`${i}/*`,$=`${f(m)?await j(m,{encoding:"utf-8"}):""}
${E}`,C=s(n,i.split("/").pop()),d={cwd:a},F=`remote-${Date.now()}-${Math.random().toString(36).slice(2)}`;return c("git init --quiet",d).then(()=>c(`git remote add ${F} https://github.com/${p}/${y}`,d),e).then(async()=>{try{if((await c("git config --get core.sparseCheckout",d)).stdout.trim()==="true")return}catch{}return c("git config core.sparseCheckout true",d)},e).then(()=>x(m,$),e).then(()=>c(`git pull ${F} --quiet ${l} --depth 1`,d),e).then(()=>I(s(a,i),C),e).then(()=>h(a),e)}function P(t,o,e){const u=S(o),n=H(e),i=w(t),r={option:u,callback:n,gitInfo:i};b(u.output).then(()=>(i.isRepo?M:O)(r),n).then(()=>n(null),n)}function T(t,o){return new Promise((e,u)=>{P(t,o,n=>{n?u(n):e()})})}function W(t){return!t||typeof t!="string"?!1:/^https?:\/\/github\.com\/[\w.-]+\/[\w.-]+/.test(t)}function _(t,o){return typeof t=="string"?t:o}async function z(t){try{const o=t.url||t._[0];o||(console.error("\u274C Error: URL is required"),console.log("Use --help for usage information"),g(1)),W(o)||(console.error("\u274C Error: Invalid GitHub URL format"),console.log("Please provide a valid GitHub repository, file, or directory URL"),g(1));const e=w(o),u=typeof t.name=="string"?t.name:e.project;let n;u?n=`./${u}`:n=`./${e.project}`;const i={output:n,branch:_(t.branch,e.branch||"master")};console.log(`\u{1F680} Starting download from: ${o}`),console.log(`\u{1F4C1} Output directory: ${i.output}`),await T(o,i),console.log("\u2705 Download completed successfully!")}catch(o){console.error("\u274C Download failed:",o instanceof Error?o.message:String(o)),g(1)}}const J=D({meta:{name:"gd",description:"\u4E0B\u8F7D GitHub \u4ED3\u5E93\u6587\u4EF6\u6216\u76EE\u5F55",version:L},args:{url:{type:"positional",description:"GitHub \u4ED3\u5E93URL\u6216\u6587\u4EF6/\u76EE\u5F55URL",required:!0},output:{type:"string",description:"\u6307\u5B9A\u5B8C\u6574\u7684\u8F93\u51FA\u8DEF\u5F84\uFF0C\u652F\u6301\u76F8\u5BF9\u6216\u7EDD\u5BF9\u8DEF\u5F84 (\u4F8B\u5982: ./path \u6216 /path)",alias:["o","out"]},branch:{type:"string",description:"\u6307\u5B9A\u8981\u4E0B\u8F7D\u7684\u5206\u652F\u540D\u79F0",alias:["b"],default:"master"},help:{type:"boolean",description:"\u663E\u793A\u5E2E\u52A9\u4FE1\u606F",alias:["h"],default:!1},name:{type:"positional",description:"\u7B80\u4FBF\u65B9\u5F0F\uFF1A\u6307\u5B9A\u8F93\u51FA\u6587\u4EF6\u5939\u540D\u79F0 (\u7C7B\u4F3C git clone \u7684\u7528\u6CD5)",required:!1}},async run({args:t}){await z(t)}});B(J);
